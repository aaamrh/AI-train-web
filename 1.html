<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>

  <style>
  html,body{
    height: 100%;
    /* overflow: hidden;  */
  }
  body{
    margin: 0;
    /* user-select:none */
  }

  #canvas, #canvas2{
    background: #eee;
  }

  #code{
    border: 1px solid #ccc;
    width: 500px;
    min-height: 200px;
    max-height: 300px;
    overflow: auto;
    word-break: break-all;

  }
  #cvs{
    user-select:none
  }
  </style>
</head>
<body>
  <div id="cvs">
    <canvas id='canvas' height="800" width="800">
      哥,你的浏览器太旧了
    </canvas>
    <canvas id='canvas2' height="800" width="800">
      哥,你的浏览器太旧了
    </canvas>
  </div>
  
  <div> 
    <button id='btn1'>保存</button>
    <button id='btn2'>加载</button>
  </div>
 
  <pre id='code'></pre>


  <script src="./utils/utils.js"></script>
  <script src="./tools.js"></script>
  <script src="./components/box.js"></script>
  <script src="./components/line.js"></script>
  <script>
    /** 
     *  STATE 设置: 
     *    鼠标点下: 如果在box上: 拖拽（isDrag）
     *             如果在knot上: 画线（isDrawLine）
     *             dragOrLine() 
     * 
     *  STATE 还原：
     *    doc鼠标抬起: mosdown = false, mosup = true
     *                isDrag = false, STATE.isDrawLine = false;
     *                O.optBox = null, O.optKnot = null;
     * 
     * // TODO:  
     * // 连线时候的吸附功能
     * // 加载完后鼠标放上回到原来的状态 
     * 
    */
    let cv1 = document.getElementById('canvas');
    let ctx1 = cv1.getContext('2d');

    let cv2 = document.getElementById('canvas2')
    let ctx2 = cv2.getContext('2d');

    // 获取鼠标在canvas上的坐标
    let mousePos = T.getMousePos(cv);
    let mousePos2 = T.getMousePos(cv2);

    let save = document.getElementById('btn1');
    let load = document.getElementById('btn2');
    let code = document.getElementById('code')

    // FIXME: 当出现滚动条时会影响鼠标在box上的判断
    let scrollTop=0, scrollLeft=0;

    let O = {
      boxes:[],
      boxes1:{},
      knots:{},
      lines:{},
      hoverBox:null,
      hoverKnot:null,
      optBox: null,
      optKnot: null,
      tempLine: null,
      trash: null
    }
    let STATE = {
      mosdown:false,
      mosup:true,
      isDrag: false,
      isDrawLine: false,
    }
  
    let box1 = new TitleBox({x:100, y:100,ctx: ctx1})
    let box2 = new Box({x:150, y:150, topBg:'red',ctx: ctx1})
    let box3 = new Box({x:200, y:200, topBg:'pink',ctx: ctx1})
    let box4 = new Box({x:250, y:250, topBg:'yellow',ctx: ctx1})
    let box5 = new Box({x:300, y:300, topBg:'orange',ctx: ctx1})
    O.boxes1[box1.id] = box1;
    O.boxes1[box2.id] = box2;
    O.boxes1[box3.id] = box3;
    O.boxes1[box4.id] = box4;
    O.boxes1[box5.id] = box5;


    O.boxes.push(box1)
    O.boxes.push(box2)
    O.boxes.push(box3)
    O.boxes.push(box4)
    O.boxes.push(box5)


    /** 
     * 1. 鼠标点下， 判断是拖拽还是连线  
     * 2. 鼠标移动， 拖拽 || 连线
    */
    cv1.addEventListener('mousedown', (ev)=>{
      STATE.mosdown = true;
      STATE.mosup = false;

      let posOnObj = isMouseOnObj();
      if(!posOnObj) {return}

      let knotActive = isPointKnot(mousePos)
      if( knotActive ){ 
        O.optKnot = O.hoverBox.knots[knotActive.id] 
        O.tempLine = new Line({ctx: ctx1})
      }

      //  设置 STATE: drag drawLine
      if(posOnObj){ dragOrLine( posOnObj ) }           
      let opts = options(posOnObj)

      cv1.addEventListener('mousemove', opts)
      cv1.addEventListener('mouseup', ()=>{
        cv1.removeEventListener('mousemove', opts)
      })
      cv1.addEventListener('mouseout', ()=>{
        cv1.removeEventListener('mousemove', opts)
      })
    })  // mousedown END

    
    function options(posOnObj){
      return function(){    
        if(STATE.isDrag){                       
          O.optBox.transform({
            x: mousePos.x - posOnObj.x,
            y: mousePos.y - posOnObj.y
          })

          function updatePos(){
            let line = null, fromKnot, fromBox, toKnot, toBox;

            for(let i in O.lines){
              line = O.lines[i];

              fromKnot = line.from.knot.id
              fromBox = line.from.box.id
              toBox = line.to.box.id
              toKnot = line.to.knot.id

              line.transform({
                start: O.boxes1[fromBox].knots[fromKnot],
                to: O.boxes1[toBox].knots[toKnot]
              })
            }
          }
          updatePos()

          refresh()
        }

        if(STATE.isDrawLine){
          O.tempLine.drawLine({
            startX: O.optKnot.junction.x,
            startY: O.optKnot.junction.y,
            endX: mousePos.x,
            endY: mousePos.y
          })
        }
      }
    }


    cv1.addEventListener('mousemove', function(){
      // BUG: 拖拽时，鼠标移动过快会丢失 hoverbox
      // console.log('--------------------------')
      // console.log(O.optBox)
      // console.log(O.hoverBox)
      // console.log(O.optKnot)
      // console.log(O.hoverKnot)
      if( isMouseOnObj() ){
        O.hoverBox.transform({ ishover: true })

        let actKnot = isPointKnot(mousePos);
        setKnotStyle(actKnot)
        refresh()
        if( !actKnot ){ O.hoverKnot = null }
      }else{
        if(!STATE.isDrag){
          O.hoverBox = null;
        }
        O.hoverKnot = null;
      }
    })

    cv1.addEventListener('mouseup', ()=>{
      if( !O.hoverKnot ){ return }
      if( O.optBox.id === O.hoverBox.id ){ return }

      let line1 = new Line({
        ctx: ctx1,
        from: {
          box: O.optBox,
          knot: O.optKnot
        },
        to: {
          box: O.hoverBox,
          knot: O.hoverKnot
        },
        start : {
          x: O.optKnot.junction.x,
          y: O.optKnot.junction.y
        },
        end : {
          x: mousePos.x,
          y: mousePos.y
        }
      })
      O.lines[line1.id] = line1;
      // FIXME: 拖拽时，鼠标如果是在 canvas 外部释放，则还原 box 的位置
    })
       
   
    document.addEventListener('mousemove', function(){})


    document.addEventListener('mouseup', (ev)=>{ 
      STATE.mosdown = false;
      STATE.mosup = true;

      STATE.isDrag = false;
      STATE.isDrawLine = false; 

      O.optBox = null;
      O.optKnot = null;

      O.tempLine = null;

      console.log(O, STATE)

      
    })
    
    /**
     * 鼠标是否在 obj 上
     * 如果在：修改 O.obj,  STATE.isDrag
     * @return {鼠标在obj上的位置|false} 
     * NOTICE: 这里设置 O.obj,  O.knot
     * 
     * （移动 && 点击） 都会判断 mos是否在对象上
     */
    function isMouseOnObj(){
      let result;
      let num = 0;

      for(let i=O.boxes.length-1; i>=0; i--){

        O.boxes[i].transform({ ishover:false })
       
        if( O.boxes[i].isPoint(mousePos) ){  // 鼠标在box上
          // 鼠标在多个box重合的地方时，所有的box会都有边框,因此只设置第一个box的hover状态(num == 0)
          if(num == 0){
            if(STATE.mosdown){  // 第一次点击（不拖拽，不画线）时设置 optBox
              if( !STATE.isDrag && !STATE.isDrawLine ){ O.optBox = O.boxes[i] };
            }
            if(!STATE.isDrag){ O.hoverBox = O.boxes[i] }

            O.hoverBox.transform({ ishover: true });
            num++;
          }

          result = getPosOnObj()
        }
      }
      refresh()

      if(!result){ return false }
      return result;
    }  // isMouseOnObj  END

    
    /**
     * 获取鼠标在 obj 上的坐标
     */
    function getPosOnObj(){
      let pos = {};
      pos.x = mousePos.x - O.hoverBox.x;
      pos.y = mousePos.y - O.hoverBox.y;
      return pos
    }


    function isPointKnot(pos){
      // 鼠标是否在 连接点 上, 是返回该 knot，不是返回 false
      return O.hoverBox.isPointKnot(pos)
    }


    function setKnotStyle(knot){
      // 设置 knot 的 hover 样式
      if( knot ){
        knot.fillStyle = 'red';
        // 节点对应的box存储到 knots ： {'left-knot': Box1}
        O.knots[ knot.id ] = O.hoverBox;
        O.hoverKnot = O.hoverBox.knots[knot.id];
      }else{
        // O.hoverKnot = null;
        let box = null;
        for(let id in O.knots){
          box = O.knots[id];
          box.knots[id].fillStyle = '#333';
        }
      }
    }


    function dragOrLine(o){
      // 拖拽: 鼠标点击对象 && 不在连接点上 
      if( o && !STATE.isDrawLine ){ STATE.isDrag = true }

      // 如果点击在 knot 上不是拖动， 是连线
      if( isPointKnot(mousePos) ){  
        STATE.isDrag = false;
        STATE.isDrawLine = true; 
      }
    }

        
    function refresh(){
      ctx1.clearRect(0, 0, cv1.width, cv1.height);
      O.boxes.forEach( item => item.draw() )
      
      for(let i in O.lines){ O.lines[i].draw() }
    }

    save.onclick = function(){
      var res = {};
      res.boxes = O.boxes1;
      res.lines = O.lines;
      
      // code.innerHTML = JSON.stringify(res, null, 2)
      code.innerHTML = JSON.stringify(res)
    }

    load.onclick = function(){
      let o;
      let data = {"boxes":{"box-iJgbBP":{"_hash":"iJgbBP","id":"box-iJgbBP","ctx":{},"x":100,"y":100,"w":160,"topH":150,"bottomH":50,"topBg":"#fff","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-iJgbBP":{"id":"top-knot-iJgbBP","x":180,"y":104,"r":4,"fillStyle":"#333","junction":{"x":180,"y":100}},"right-knot-iJgbBP":{"id":"right-knot-iJgbBP","x":256,"y":200,"r":4,"fillStyle":"#333","junction":{"x":260,"y":200}},"bottom-knot-iJgbBP":{"id":"bottom-knot-iJgbBP","x":180,"y":296,"r":4,"fillStyle":"#333","junction":{"x":180,"y":300}},"left-knot-iJgbBP":{"id":"left-knot-iJgbBP","x":104,"y":200,"r":4,"fillStyle":"#333","junction":{"x":100,"y":200}}},"lines":{"length":0},"ishover":false},"box-PmZOn1":{"_hash":"PmZOn1","id":"box-PmZOn1","ctx":{},"x":150,"y":150,"w":160,"topH":150,"bottomH":50,"topBg":"red","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-PmZOn1":{"id":"top-knot-PmZOn1","x":230,"y":154,"r":4,"fillStyle":"#333","junction":{"x":230,"y":150}},"right-knot-PmZOn1":{"id":"right-knot-PmZOn1","x":306,"y":250,"r":4,"fillStyle":"#333","junction":{"x":310,"y":250}},"bottom-knot-PmZOn1":{"id":"bottom-knot-PmZOn1","x":230,"y":346,"r":4,"fillStyle":"#333","junction":{"x":230,"y":350}},"left-knot-PmZOn1":{"id":"left-knot-PmZOn1","x":154,"y":250,"r":4,"fillStyle":"#333","junction":{"x":150,"y":250}}},"lines":{"length":0},"ishover":false},"box-OE4D9D":{"_hash":"OE4D9D","id":"box-OE4D9D","ctx":{},"x":200,"y":200,"w":160,"topH":150,"bottomH":50,"topBg":"pink","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-OE4D9D":{"id":"top-knot-OE4D9D","x":280,"y":204,"r":4,"fillStyle":"#333","junction":{"x":280,"y":200}},"right-knot-OE4D9D":{"id":"right-knot-OE4D9D","x":356,"y":300,"r":4,"fillStyle":"#333","junction":{"x":360,"y":300}},"bottom-knot-OE4D9D":{"id":"bottom-knot-OE4D9D","x":280,"y":396,"r":4,"fillStyle":"#333","junction":{"x":280,"y":400}},"left-knot-OE4D9D":{"id":"left-knot-OE4D9D","x":204,"y":300,"r":4,"fillStyle":"#333","junction":{"x":200,"y":300}}},"lines":{"length":0},"ishover":false},"box-JCEr7G":{"_hash":"JCEr7G","id":"box-JCEr7G","ctx":{},"x":127,"y":569,"w":160,"topH":150,"bottomH":50,"topBg":"yellow","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-JCEr7G":{"id":"top-knot-JCEr7G","x":207,"y":573,"r":4,"fillStyle":"#333","junction":{"x":207,"y":569}},"right-knot-JCEr7G":{"id":"right-knot-JCEr7G","x":283,"y":669,"r":4,"fillStyle":"#333","junction":{"x":287,"y":669}},"bottom-knot-JCEr7G":{"id":"bottom-knot-JCEr7G","x":207,"y":765,"r":4,"fillStyle":"#333","junction":{"x":207,"y":769}},"left-knot-JCEr7G":{"id":"left-knot-JCEr7G","x":131,"y":669,"r":4,"fillStyle":"#333","junction":{"x":127,"y":669}}},"lines":{"length":0},"ishover":false},"box-hlZ1eb":{"_hash":"hlZ1eb","id":"box-hlZ1eb","ctx":{},"x":439,"y":322,"w":160,"topH":150,"bottomH":50,"topBg":"orange","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-hlZ1eb":{"id":"top-knot-hlZ1eb","x":519,"y":326,"r":4,"fillStyle":"#333","junction":{"x":519,"y":322}},"right-knot-hlZ1eb":{"id":"right-knot-hlZ1eb","x":595,"y":422,"r":4,"fillStyle":"#333","junction":{"x":599,"y":422}},"bottom-knot-hlZ1eb":{"id":"bottom-knot-hlZ1eb","x":519,"y":518,"r":4,"fillStyle":"#333","junction":{"x":519,"y":522}},"left-knot-hlZ1eb":{"id":"left-knot-hlZ1eb","x":443,"y":422,"r":4,"fillStyle":"#333","junction":{"x":439,"y":422}}},"lines":{"length":0},"ishover":false}},"lines":{"Line-80JVkr":{"_hash":"80JVkr","id":"Line-80JVkr","from":{"box":{"_hash":"hlZ1eb","id":"box-hlZ1eb","ctx":{},"x":439,"y":322,"w":160,"topH":150,"bottomH":50,"topBg":"orange","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-hlZ1eb":{"id":"top-knot-hlZ1eb","x":519,"y":326,"r":4,"fillStyle":"#333","junction":{"x":519,"y":322}},"right-knot-hlZ1eb":{"id":"right-knot-hlZ1eb","x":595,"y":422,"r":4,"fillStyle":"#333","junction":{"x":599,"y":422}},"bottom-knot-hlZ1eb":{"id":"bottom-knot-hlZ1eb","x":519,"y":518,"r":4,"fillStyle":"#333","junction":{"x":519,"y":522}},"left-knot-hlZ1eb":{"id":"left-knot-hlZ1eb","x":443,"y":422,"r":4,"fillStyle":"#333","junction":{"x":439,"y":422}}},"lines":{"length":0},"ishover":false},"knot":{"id":"left-knot-hlZ1eb","x":443,"y":422,"r":4,"fillStyle":"red","junction":{"x":439,"y":422}}},"to":{"box":{"_hash":"OE4D9D","id":"box-OE4D9D","ctx":{},"x":200,"y":200,"w":160,"topH":150,"bottomH":50,"topBg":"pink","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-OE4D9D":{"id":"top-knot-OE4D9D","x":280,"y":204,"r":4,"fillStyle":"#333","junction":{"x":280,"y":200}},"right-knot-OE4D9D":{"id":"right-knot-OE4D9D","x":356,"y":300,"r":4,"fillStyle":"#333","junction":{"x":360,"y":300}},"bottom-knot-OE4D9D":{"id":"bottom-knot-OE4D9D","x":280,"y":396,"r":4,"fillStyle":"#333","junction":{"x":280,"y":400}},"left-knot-OE4D9D":{"id":"left-knot-OE4D9D","x":204,"y":300,"r":4,"fillStyle":"#333","junction":{"x":200,"y":300}}},"lines":{"length":0},"ishover":false},"knot":{"id":"top-knot-OE4D9D","x":280,"y":204,"r":4,"fillStyle":"red","junction":{"x":280,"y":200}}},"start":{"x":439,"y":422},"end":{"x":281,"y":201}},"Line-T0eRDP":{"_hash":"T0eRDP","id":"Line-T0eRDP","from":{"box":{"_hash":"OE4D9D","id":"box-OE4D9D","ctx":{},"x":200,"y":200,"w":160,"topH":150,"bottomH":50,"topBg":"pink","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-OE4D9D":{"id":"top-knot-OE4D9D","x":280,"y":204,"r":4,"fillStyle":"#333","junction":{"x":280,"y":200}},"right-knot-OE4D9D":{"id":"right-knot-OE4D9D","x":356,"y":300,"r":4,"fillStyle":"#333","junction":{"x":360,"y":300}},"bottom-knot-OE4D9D":{"id":"bottom-knot-OE4D9D","x":280,"y":396,"r":4,"fillStyle":"#333","junction":{"x":280,"y":400}},"left-knot-OE4D9D":{"id":"left-knot-OE4D9D","x":204,"y":300,"r":4,"fillStyle":"#333","junction":{"x":200,"y":300}}},"lines":{"length":0},"ishover":false},"knot":{"id":"top-knot-OE4D9D","x":280,"y":204,"r":4,"fillStyle":"#333","junction":{"x":280,"y":200}}},"to":{"box":{"_hash":"PmZOn1","id":"box-PmZOn1","ctx":{},"x":150,"y":150,"w":160,"topH":150,"bottomH":50,"topBg":"red","bottomBg":"#b4b4b4","borderRadius":0,"knots":{"top-knot-PmZOn1":{"id":"top-knot-PmZOn1","x":230,"y":154,"r":4,"fillStyle":"#333","junction":{"x":230,"y":150}},"right-knot-PmZOn1":{"id":"right-knot-PmZOn1","x":306,"y":250,"r":4,"fillStyle":"#333","junction":{"x":310,"y":250}},"bottom-knot-PmZOn1":{"id":"bottom-knot-PmZOn1","x":230,"y":346,"r":4,"fillStyle":"#333","junction":{"x":230,"y":350}},"left-knot-PmZOn1":{"id":"left-knot-PmZOn1","x":154,"y":250,"r":4,"fillStyle":"#333","junction":{"x":150,"y":250}}},"lines":{"length":0},"ishover":false},"knot":{"id":"top-knot-PmZOn1","x":230,"y":154,"r":4,"fillStyle":"red","junction":{"x":230,"y":150}}},"start":{"x":280,"y":200},"end":{"x":228,"y":157}}}}
      ctx1.clearRect(0, 0, cv1.width, cv1.height);
      
      const mapping = {
        'boxes': function(data){ 
          let {x,y,w,topH,bottomH,topBg,bottomBg,borderRadius} = data
          let ctx = ctx1
          o = new Box({x,y,w,topH,bottomH,topBg,bottomBg,borderRadius, ctx})
          o.draw()
        },
        'lines': function(data){
          console.log(data)
          let { id, from, to, start, end } = data
          o = new Line({ctx:ctx1, id, from, to, start, end})
          o.draw()
        }
      }
      for(let i in data){
        for(let j in data[i]){
          mapping[i]( data[i][j] )
        }
      }
    }

    function copy2Ctx2(){
      // console.log(O.optBox)
      ctx2.clearRect(0, 0, cv1.width, cv1.height);
      if( O.optBox ){
        let ctx = ctx2;
        let { w, topH, bottomH, topBg, bottomBg, borderRadius } = O.optBox;
        let x = mousePos2.x - w/2;
        let y = mousePos2.y - (topH + bottomH)/2
        /** 
         * TODO:  
         * 2. 跟随鼠标移动
         * 3. 鼠标在 cv2上mosup, 在cv上mosup
        */
        o = new Box({x, y, w, topH, bottomH, topBg, bottomBg, borderRadius, ctx})
        o.draw()
      }
    }

    cv2.addEventListener('mousemove', function(){
      copy2Ctx2()
    })
  
    cv2.addEventListener('mouseover', function(){
      console.log(O, STATE)
    })

    cv2.addEventListener('mouseup', function(){
      O.hoverBox.transform({ ishover: false });
      O.hoverBox = null
      refresh()
    })
    /*
      var yImg = new Image();
      yImg.src = './arcTo.png';
      yImg.onload = function(){
        draw(this)
      }
      function draw(obj){
        ctx1.drawImage(obj, 100, 50) 
      }
    */


  </script>
</body>
</html>